<html>
  <meta charset="utf-8">
  <title>data demo</title>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
  <style>
  adiv {
    width: 100px;
    height: 100px;
    border: 1px solid #000;
    float: left;
  }
  </style>
  <script src="http://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>



<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
       

<script>
      google.charts.load('current', {'packages':['table']});
      google.charts.setOnLoadCallback(finishLoading);
      
      function finishLoading(){
        url = "/api/query?max=50"
        if ( $('#clno').val().length > 1){
          url = url + "&cl=" + $('#clno').val()
        }
        console.log("url is ", url)
        $.getJSON( url, function(data){
        console.log(data);
        g_data = data;
        drawTableData();
        })
      }

      /* https://ischurov.github.io/pythonvjs/ */

      function comparekey(a, b){
         if( a== 'TaskID' ) {
            return true;
         }
         return a >b ;
      }

      function getKs( jsonobject ){
        ks = Object.keys( jsonobject )  // jsonobject is a dict / object
        ks.sort();
        ks.splice( ks.indexOf('TaskID'), 1)
        ks.splice( ks.indexOf('Status'), 1)
        ks.splice( ks.indexOf('Platform'), 1)
        ks.splice( ks.indexOf('ChipName'), 1)
        ks.reverse()
        ks.push('ChipName')
        ks.push('Platform')
        ks.push('Status')
        ks.push('TaskID')
        ks.reverse()
        return ks
      }

      function getKs2(jsonobject){
        return ['TaskID', 'Status', 'ChipName', 'Platform', 'Mode' , 'AssignedTo', 'CreatedTime', 'P4Label', 'Result',
         'LoadBuildResult', 'SendMailResult', 
         'LoadBuildFinishTime', 'TestFinishTime']
      }

      function getWaitString( msec ){
        // calculate msec to readable string
        left = msec;
        ds = Math.ceil( msec / (3600000*24))
        left = left % (3600000*24)
        hs = Math.ceil( left / 3600000 )
        left = left % 3600000
        ms = Math.ceil( left / 60000 )
        left = left %60000
        return " " + ds + " days " + hs + " hours " + ms + " mins";

      }

      function drawTableData() {
        var data = new google.visualization.DataTable();
        var ks =  getKs2( g_data[0] )
        // add calculated columns
        data.addColumn('string', 'Now-CreatedTime');
        data.addColumn('string', 'Now-LoadedTime');

        for (i in ks){
           data.addColumn('string', ks[i]);
        }
        for ( index in g_data){
          newrow = []
          // add calculated columns
          t1 = new Date( g_data[index]['CreatedTime'] );
          t2 = new Date( g_data[index]['LoadBuildFinishTime'] );
          t3 = new Date(  )
          // now-
          

          newrow.push ( getWaitString( ((t3-t1)) )) ;
          newrow.push ( getWaitString( ((t3-t2)) ) );
          for( i in ks ){
           newrow.push( '' + g_data[index][ks[i]]);
           //console.log(newrow);
          }
          data.addRow( Object.values(newrow))
        }
        var table = new google.visualization.Table(document.getElementById('table_div'));

        table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});
         
      }

      function drawTable() {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Name');
        data.addColumn('number', 'Salary');
        data.addColumn('boolean', 'Full Time Employee');
        data.addRows([
          ['Mike',  {v: 10000, f: '$10,000'}, true],
          ['Jim',   {v:8000,   f: '$8,000'},  false],
          ['Alice', {v: 12500, f: '$12,500'}, true],
          ['Bob',   {v: 7000,  f: '$7,000'},  true]
        ]);

        var table = new google.visualization.Table(document.getElementById('table_div'));

        table.draw(data, {showRowNumber: true, width: '100%', height: '100%'});
         
      }
      function new_query(){
        console.log( "new_query ", $('#clno').val() );
        finishLoading();
      }
      
      $(document).ready( () =>  {
        console.log('ready!');
        $("#clno").click(function () {
          console.log("clno input clicked !")
          //finishLoading();
        });

        $("#clno").on('keydown', function(e) { 
            if (e.which == 13) { 
              console.log("keydown enter");
              finishLoading();
            }else{
              console.log("e.which ", e.which);
            } 
            
            }
            
            );

      });
</script>
<body>

  <input value="71" id="clno" /> <input type="button" value="Query CL in P4Label column" > </button>
<div id="table_div"></div>

<br/>

<div id="one"></div>
<div id="two"></div>
<div id="three"></div>
 
<script>

</script>
</body>
</html>